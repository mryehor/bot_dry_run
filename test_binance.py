from binance_client import binance_client
from binance.client import Client
import os
from config import API_KEY, API_SECRET, TRADING_MODE  # –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∏–∑ config.py

def test_binance_connection():
    """–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Binance"""
    
    print(f"=== –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è Binance (–†–µ–∂–∏–º: {TRADING_MODE.upper()}) ===")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–ª—é—á–µ–π
    if not API_KEY or not API_SECRET:
        print("‚ùå API_KEY –∏–ª–∏ API_SECRET –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã")
        print("–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π–ª .env –∏–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è")
        return False
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —Ç–µ—Å—Ç–æ–≤–∞—è —ç—Ç–æ —Å–µ—Ç—å –∏–ª–∏ —Ä–µ–∞–ª—å–Ω–∞—è
    is_testnet = 'test' in API_KEY.lower() or TRADING_MODE == 'dryrun'
    
    try:
        # –°–æ–∑–¥–∞–µ–º –∫–ª–∏–µ–Ω—Ç —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
        if TRADING_MODE == 'real':
            # –†–ï–ê–õ–¨–ù–ê–Ø —Ç–æ—Ä–≥–æ–≤–ª—è
            print("üî¥ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –†–ï–ê–õ–¨–ù–û–ô —Ç–æ—Ä–≥–æ–≤–ª–µ Binance...")
            client = Client(API_KEY, API_SECRET)
            print("‚úÖ –ö–ª–∏–µ–Ω—Ç –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–π —Ç–æ—Ä–≥–æ–≤–ª–∏ —Å–æ–∑–¥–∞–Ω")
        else:
            # –¢–ï–°–¢–û–í–ê–Ø —Å–µ—Ç—å
            print("üü° –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –¢–ï–°–¢–û–í–û–ô —Å–µ—Ç–∏ Binance...")
            client = Client(API_KEY, API_SECRET, testnet=True)
            print("‚úÖ –ö–ª–∏–µ–Ω—Ç –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–π —Å–µ—Ç–∏ —Å–æ–∑–¥–∞–Ω")
        
        # –¢–µ—Å—Ç 1: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–≤–µ—á–µ–π
        print("\nüìä –¢–µ—Å—Ç 1: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–≤–µ—á–µ–π...")
        try:
            candles = client.futures_klines(symbol="BTCUSDT", interval="5m", limit=5)
            print(f"‚úÖ –£—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–∏–ª–∏ {len(candles)} —Å–≤–µ—á–µ–π BTCUSDT")
            print(f"   –ü–æ—Å–ª–µ–¥–Ω—è—è —Ü–µ–Ω–∞: {float(candles[-1][4]):.2f}")
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–≤–µ—á–µ–π: {e}")
            return False
        
        # –¢–µ—Å—Ç 2: –ü–æ–ª—É—á–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
        print("\nüí∞ –¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞...")
        try:
            if TRADING_MODE == 'real':
                # –î–ª—è —Ä–µ–∞–ª—å–Ω–æ–π —Ç–æ—Ä–≥–æ–≤–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º futures
                account = client.futures_account()
                print(f"‚úÖ –ë–∞–ª–∞–Ω—Å —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω")
                print(f"   –û–±—â–∏–π –±–∞–ª–∞–Ω—Å: {float(account['totalWalletBalance']):.2f} USDT")
                print(f"   –°–≤–æ–±–æ–¥–Ω—ã–π –±–∞–ª–∞–Ω—Å: {float(account['availableBalance']):.2f} USDT")
            else:
                # –î–ª—è —Ç–µ—Å—Ç–æ–≤–æ–π —Å–µ—Ç–∏
                account = client.futures_account()
                print(f"‚úÖ –ë–∞–ª–∞–Ω—Å —Ç–µ—Å—Ç–æ–≤–æ–π —Å–µ—Ç–∏ –ø–æ–ª—É—á–µ–Ω")
                print(f"   –¢–µ—Å—Ç–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: {float(account['availableBalance']):.2f} USDT")
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–∞: {e}")
            # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ç–µ—Å—Ç, —Ç–∞–∫ –∫–∞–∫ –¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –∫–ª—é—á–µ–π –º–æ–∂–µ—Ç –Ω–µ –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ—å—é—á–µ—Ä—Å–∞–º
        
        # –¢–µ—Å—Ç 3: –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∞–∫–∫–∞—É–Ω—Ç–µ
        print("\nüë§ –¢–µ—Å—Ç 3: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–∫–∫–∞—É–Ω—Ç–µ...")
        try:
            account_info = client.futures_account()
            print(f"‚úÖ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–∫–∫–∞—É–Ω—Ç–µ –ø–æ–ª—É—á–µ–Ω–∞")
            print(f"   –ê–∫–∫–∞—É–Ω—Ç –∞–∫—Ç–∏–≤–µ–Ω: –î–∞")
            print(f"   –ö–æ–º–∏—Å—Å–∏—è —Ç–µ–π–∫–µ—Ä–∞: {float(account_info.get('commissionTaker', 0))*100:.4f}%")
        except Exception as e:
            print(f"‚ö†Ô∏è  –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–∫–∫–∞—É–Ω—Ç–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞: {e}")
        
        # –¢–µ—Å—Ç 4: –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–∏—Ö –ø–æ–∑–∏—Ü–∏–π
        print("\nüìà –¢–µ—Å—Ç 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π...")
        try:
            positions = client.futures_position_information()
            open_positions = [p for p in positions if float(p['positionAmt']) != 0]
            if open_positions:
                print(f"‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω—ã –æ—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏: {len(open_positions)}")
                for pos in open_positions[:3]:  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 3
                    print(f"   - {pos['symbol']}: {pos['positionAmt']} (PnL: {pos['unRealizedProfit']})")
            else:
                print(f"‚úÖ –ù–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π")
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–æ–∑–∏—Ü–∏–π: {e}")
        
        # –¢–µ—Å—Ç 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
        print("\nüîê –¢–µ—Å—Ç 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π API –∫–ª—é—á–∞...")
        try:
            api_permissions = client.futures_account()
            if account:
                print(f"‚úÖ API —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è:")
                print(f"   –ß—Ç–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞: ‚úÖ –†–∞–∑—Ä–µ—à–µ–Ω–æ")
                print(f"   –¢–æ—Ä–≥–æ–≤–ª—è: {'‚úÖ –†–∞–∑—Ä–µ—à–µ–Ω–æ' if float(account.get('availableBalance', 0)) >= 0 else '‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}")

        except Exception as e:
            print(f"‚ö†Ô∏è  –†–∞–∑—Ä–µ—à–µ–Ω–∏—è API –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã: {e}")
        
        print("\n" + "="*50)
        if TRADING_MODE == 'real':
            print(f"üö® –í–ê–ñ–ù–û: –í—ã –ø–æ–¥–∫–ª—é—á–µ–Ω—ã –∫ –†–ï–ê–õ–¨–ù–û–ô —Ç–æ—Ä–≥–æ–≤–ª–µ Binance!")
            print(f"   –ë–æ—Ç –±—É–¥–µ—Ç —Å–æ–≤–µ—Ä—à–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ —Å–¥–µ–ª–∫–∏ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–µ–Ω—å–≥–∞–º–∏!")
            print(f"   –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ–Ω–∏–º–∞–µ—Ç–µ –≤—Å–µ —Ä–∏—Å–∫–∏!")
        else:
            print(f"‚úÖ –í—ã –ø–æ–¥–∫–ª—é—á–µ–Ω—ã –∫ –¢–ï–°–¢–û–í–û–ô —Å–µ—Ç–∏ Binance")
            print(f"   –í—Å–µ —Å–¥–µ–ª–∫–∏ –±—É–¥—É—Ç –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–º–∏, –±–µ–∑ —Ä–∏—Å–∫–∞ –¥–ª—è —Å—Ä–µ–¥—Å—Ç–≤")
        
        return True
        
    except Exception as e:
        print(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: {e}")
        print(f"–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:")
        print(f"1. –ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å API –∫–ª—é—á–µ–π")
        print(f"2. –†–∞–∑—Ä–µ—à–µ–Ω–∏—è API –∫–ª—é—á–∞ (–Ω—É–∂–Ω–∞ —Ñ—å—é—á–µ—Ä—Å–Ω–∞—è —Ç–æ—Ä–≥–æ–≤–ª—è)")
        print(f"3. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ IP (–µ—Å–ª–∏ –µ—Å—Ç—å)")
        if TRADING_MODE == 'real':
            print(f"4. –ß—Ç–æ –∫–ª—é—á–∏ –æ—Ç –†–ï–ê–õ–¨–ù–û–ì–û –∞–∫–∫–∞—É–Ω—Ç–∞, –∞ –Ω–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ")
        return False

def test_telegram():
    """–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Telegram –±–æ—Ç–∞"""
    from telegram_bot import send_telegram_message
    
    print(f"\n=== –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Telegram –±–æ—Ç–∞ ===")
    
    try:
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        message = f"""
üîß *–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ*
–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –±–æ—Ç–∞.

üìä *–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:*
‚Ä¢ –†–µ–∂–∏–º: {TRADING_MODE.upper()}
‚Ä¢ –í—Ä–µ–º—è: {os.path.basename(__file__)}
‚Ä¢ –°—Ç–∞—Ç—É—Å: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–≤—è–∑–∏
"""
        send_telegram_message(message)
        print("‚úÖ –¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram")
        return True
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram: {e}")
        return False

def run_all_tests():
    """–ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤"""
    print("üß™ –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤ —Å–∏—Å—Ç–µ–º—ã...")
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Binance
    binance_ok = test_binance_connection()
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º Telegram
    telegram_ok = test_telegram()
    
    print("\n" + "="*50)
    print("üìã –†–ï–ó–£–õ–¨–¢–ê–¢–´ –¢–ï–°–¢–û–í:")
    print(f"Binance –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ: {'‚úÖ –£—Å–ø–µ—à–Ω–æ' if binance_ok else '‚ùå –û—à–∏–±–∫–∞'}")
    print(f"Telegram –±–æ—Ç: {'‚úÖ –£—Å–ø–µ—à–Ω–æ' if telegram_ok else '‚ùå –û—à–∏–±–∫–∞'}")
    
    if binance_ok and telegram_ok:
        print("\nüéâ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!")
        if TRADING_MODE == 'real':
            print("üö® –í–ù–ò–ú–ê–ù–ò–ï: –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –†–ï–ê–õ–¨–ù–û–ô —Ç–æ—Ä–≥–æ–≤–ª–µ!")
        else:
            print("‚úÖ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ç–µ—Å—Ç–æ–≤–æ–π —Ç–æ—Ä–≥–æ–≤–ª–µ")
        return True
    else:
        print("\n‚ö†Ô∏è  –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ç–µ—Å—Ç—ã –Ω–µ –ø—Ä–æ–π–¥–µ–Ω—ã")
        print("–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –±–æ—Ç–∞")
        return False

if __name__ == "__main__":
    # –ó–∞–ø—É—Å–∫–∞–µ–º –≤—Å–µ —Ç–µ—Å—Ç—ã
    success = run_all_tests()
    
    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–æ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–ª—è CI/CD
    exit(0 if success else 1)